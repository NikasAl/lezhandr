# План миграции CLI → Flutter

## Статус миграции

**Последнее обновление:** 2025-01-20
**Версия Flutter:** 3.x
**Версия CLI (эталон):** mv_run_client.py

---

## Сравнение функционала

### ✅ Реализовано в Flutter

| Функция | CLI файл | Flutter файл | Статус |
|---------|----------|--------------|--------|
| Авторизация device_login | mv_api.py | auth_repository.dart | ✅ Полностью |
| Просмотр источников | mv_screens.py | library_screen.dart | ✅ Полностью |
| Просмотр задач | mv_screens.py | problem_detail_screen.dart | ✅ Полностью |
| Создание решения | mv_api.py | solutions_repository.dart | ✅ Полностью |
| Сессия решения (таймер) | mv_screens.py | solution_session_screen.dart | ✅ Полностью |
| Завершение решения | mv_api.py | solutions_repository.dart | ✅ Полностью |
| Геймификация (XP, hearts) | mv_api.py | gamification_repository.dart | ✅ Полностью |
| Создание вопросов | mv_api.py | artifacts_repository.dart | ✅ Полностью |
| Создание подсказок | mv_api.py | artifacts_repository.dart | ✅ Полностью |
| Создание озарений | mv_api.py | artifacts_repository.dart | ✅ Полностью |
| OCR изображений | mv_api.py | ocr_provider.dart | ✅ Полностью |
| Загрузка изображений | mv_api.py | uploads_repository.dart | ✅ Полностью |
| Выбор AI персоны | mv_screens.py | persona_selector.dart | ✅ Полностью |

### ❌ Не реализовано / Требует доработки

| Функция | Проблема | Приоритет | Фаза | Статус |
|---------|----------|-----------|------|--------|
| **Математические формулы** | Тексты с $...$ и $$...$$ отображаются как plain text | P0 | 1 | ✅ Готово |
| **Просмотр ответов на вопросы** | Нельзя просмотреть полный ответ, только иконка | P0 | 2 | ✅ Готово |
| **AI-ответы на вопросы** | API есть, UI для запроса отсутствует | P0 | 2 | ✅ Готово |
| **Просмотр подсказок AI** | Нельзя открыть hintText из списка | P0 | 3 | ✅ Готово |
| **Редактирование подсказок** | Нельзя отредактировать текст подсказки | P1 | 3 | ✅ Готово |
| Создание задач | FAB есть, но не реализован диалог | P2 | — | ❌ Не начато |
| Анализ концепций | Экран не реализован | P2 | — | ❌ Не начато |
| Финансы/пополнение | Только просмотр баланса | P2 | — | ❌ Не начато |

---

## Фаза 1: Математические формулы

### Постановка задачи
Задачи, ответы на вопросы и подсказки AI могут содержать математические выражения в формате LaTeX:
- Inline формулы: `$E = mc^2$`
- Display формулы: `$$\int_a^b f(x)dx$$`

В CLI версии используется MathJax в браузере. В Flutter нужен нативный рендеринг.

### Решение
Использовать пакет `flutter_math_fork` для рендеринга LaTeX формул в комбинации с `flutter_markdown`.

### Задачи

- [x] 1.1 Добавить зависимость `flutter_math_fork` в `pubspec.yaml`
- [x] 1.2 Создать виджет `MarkdownWithMath` в `lib/presentation/widgets/shared/`
- [x] 1.3 Реализовать парсинг текста на сегменты (текст/inline-формула/display-формула)
- [x] 1.4 Интегрировать `MarkdownWithMath` в `ProblemDetailScreen`
- [x] 1.5 Применить в диалогах вопросов и подсказок

### Файлы для изменения

```
pubspec.yaml
lib/presentation/widgets/shared/markdown_with_math.dart (новый)
lib/presentation/screens/problems/problem_detail_screen.dart
lib/presentation/screens/solutions/solution_session_screen.dart
```

---

## Фаза 2: Просмотр ответов на вопросы

### Постановка задачи
В CLI версии (mv_screens.py:548-585) реализован полный флоу:
1. Список вопросов с превью ответа
2. Просмотр полного ответа
3. Ручной ввод ответа
4. AI-генерация ответа с выбором персоны

В Flutter только создаются вопросы, но нет просмотра.

### Решение
Добавить диалог просмотра вопроса с ответом и кнопками действий.

### Задачи

- [x] 2.1 Добавить `onTap` в `_QuestionTile` для открытия диалога
- [x] 2.2 Создать метод `_showQuestionDetailDialog` с:
  - [x] Отображением текста вопроса
  - [x] Отображением ответа (если есть) через `MarkdownWithMath`
  - [x] Полем ввода для ручного ответа
  - [x] Кнопкой "Спросить AI"
- [x] 2.3 При нажатии "Спросить AI" показать `PersonaSelector`
- [x] 2.4 После генерации обновить UI и показать ответ
- [x] 2.5 Добавить превью ответа в списке (первые 40 символов)

### Файлы для изменения

```
lib/presentation/screens/solutions/solution_session_screen.dart
```

### Связанный API (уже реализован)

```dart
// artifacts_repository.dart
Future<QuestionModel?> generateQuestionAnswer({
  required int questionId,
  PersonaId persona = PersonaId.basis,
});

Future<QuestionModel?> updateQuestion(int questionId, QuestionUpdate update);
```

---

## Фаза 3: Просмотр подсказок AI

### Постановка задачи
В CLI версии (mv_screens.py:606-680) можно:
1. Просмотреть список подсказок
2. Открыть текст подсказки
3. Редактировать текст подсказки

В Flutter `_showHintResultDialog` вызывается только после генерации новой подсказки.

### Решение
Добавить возможность открытия существующей подсказки из списка.

### Задачи

- [x] 3.1 Добавить `onTap` в `_HintTile` для открытия диалога
- [x] 3.2 Создать метод `_showHintDetailDialog` с:
  - [x] Отображением userNotes
  - [x] Отображением hintText через `MarkdownWithMath`
  - [x] Кнопкой редактирования
- [x] 3.3 Реализовать редактирование hintText с сохранением
- [x] 3.4 Добавить превью hintText в списке (первые 40 символов)

### Файлы для изменения

```
lib/presentation/screens/solutions/solution_session_screen.dart
```

### Связанный API (уже реализован)

```dart
// artifacts_repository.dart
Future<HintModel?> updateHint(int hintId, HintUpdate update);
```

---

## Оценка времени

| Фаза | Задачи | Время |
|------|--------|-------|
| 1 | Математические формулы | 4-6 часов |
| 2 | Просмотр ответов | 3-4 часа |
| 3 | Просмотр подсказок | 2-3 часа |
| **Итого** | | **9-13 часов** |

---

## Чек-лист тестирования

### Фаза 1: Формулы
- [ ] Inline формула `$x^2$` рендерится в строке
- [ ] Display формула `$$\sum_{i=1}^n i$$` рендерится отдельным блоком
- [ ] Формулы в условии задачи отображаются корректно
- [ ] Формулы в ответах AI отображаются корректно
- [ ] Формулы в подсказках отображаются корректно
- [ ] Обычный markdown (заголовки, списки) работает

### Фаза 2: Вопросы
- [ ] Клик на вопрос открывает диалог
- [ ] Ответ отображается полностью
- [ ] Можно ввести ответ вручную
- [ ] Кнопка "Спросить AI" показывает выбор персоны
- [ ] После генерации ответ отображается
- [ ] Превью ответа показывается в списке

### Фаза 3: Подсказки
- [ ] Клик на подсказку открывает диалог
- [ ] hintText отображается полностью
- [ ] Можно отредактировать текст
- [ ] Изменения сохраняются
- [ ] Статус подсказки виден в списке

---

## История изменений

| Дата | Версия | Изменения |
|------|--------|-----------|
| 2025-01-20 | 1.0 | Начальный план миграции |
| 2025-01-20 | 1.1 | Реализованы фазы 1-3: математические формулы, просмотр вопросов и подсказок |
